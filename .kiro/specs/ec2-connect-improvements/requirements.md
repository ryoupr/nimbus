# 要件定義書

## 概要

EC2 Connect ツールのパフォーマンス最適化と自動セッション管理機能の改善を行います。現在のツールは一定時間経過でセッションが切断される問題があり、ユーザーが明示的に切断しない限り、セッションを自動で維持・再接続する機能を実装します。

## 用語集

- **EC2 接続管理システム**: EC2 インスタンスへの SSM 接続を管理するメインシステム
- **セッション監視機能**: SSM セッションの状態を監視し、自動再接続を管理するコンポーネント
- **セッション管理機能**: 複数の SSM セッションを効率的に管理するコンポーネント
- **健全性チェッカー**: 接続の健全性を定期的にチェックするコンポーネント
- **自動再接続機能**: セッション切断時の自動再接続機能
- **パフォーマンス最適化機能**: 接続速度とリソース使用量を最適化するコンポーネント
- **接続診断機能**: 接続前にEC2インスタンスとSSM環境の状態を診断するコンポーネント
- **自動修復機能**: 診断で発見された問題を自動的に修復するコンポーネント
- **予防的チェック機能**: 接続失敗を事前に防ぐための包括的チェック機能

## 要件

### 要件 1: 自動セッション維持機能

**ユーザーストーリー:** 開発者として、SSM セッションが自動的に維持されることで、長時間の開発セッション中に接続が切れないようにしたい。

#### 受入基準

1. SSM セッションが確立されたとき、セッション監視機能はセッションの健全性を継続的に監視する
2. セッション健全性チェックで切断の可能性を検出したとき、セッション監視機能は予防的にセッションを更新する
3. セッションタイムアウトが近づいたとき、自動再接続機能は現在のセッションが期限切れになる前に新しいセッションを確立する
4. セッション更新が失敗したとき、自動再接続機能は指数バックオフで再接続を試行する
5. ユーザーが明示的に切断を要求していない間、セッション監視機能はアクティブなセッション状態を維持する

### 要件 2: 高速自動再接続機能

**ユーザーストーリー:** ユーザーとして、セッションが予期せず切断されたときに自動再接続されることで、作業が中断されないようにしたい。

#### 受入基準

1. アクティブなセッションが予期せず終了したとき、自動再接続機能は 5 秒以内に切断を検出する
2. 切断が検出されたとき、自動再接続機能はユーザーの介入なしに即座に再接続を試行する
3. 最初の再接続試行が失敗したとき、自動再接続機能は指数バックオフ（1 秒、2 秒、4 秒、8 秒、16 秒）で再試行する
4. 再接続が成功したとき、セッション監視機能はデータ損失なしに通常の監視を再開する
5. すべての再接続試行が失敗したとき、EC2 接続管理システムはユーザーに通知し、手動再接続オプションを提供する

### 要件 3: セッション管理最適化

**ユーザーストーリー:** システム管理者として、セッション管理が最適化されることで、複数の接続が効率的に管理され、リソース使用量が最小化されるようにしたい。

#### 受入基準

1. 同一インスタンスに対する複数の SSM セッションが要求されたとき、セッション管理機能は既存のアクティブセッションの状態を確認する
2. 既存のセッションが健全で同じポート設定のとき、セッション管理機能はユーザーに既存セッションの再利用を提案する
3. セッションが以下の条件を満たすとき、セッション管理機能はそれを非アクティブとして判定する：
   - ローカルポートへの新規接続が 30 秒以上ない
   - ポートフォワーディング経由のデータ転送が 30 秒以上ない
   - SSM セッションプロセスが応答しない状態が 5 秒以上継続
4. 複数のセッションが同時にアクティブなとき、セッション管理機能はリソース使用量を監視し、必要に応じて警告を表示する
5. セッション管理機能はリソース枯渇を防ぐため、同一インスタンスあたり最大 3 つの同時セッションを推奨制限とする

### 要件 4: パフォーマンス監視と最適化

**ユーザーストーリー:** 開発者として、接続パフォーマンスが継続的に最適化されることで、可能な限り高速な接続体験を得たい。

#### 受入基準

1. 接続が確立されたとき、パフォーマンス最適化機能は接続確立時間を測定・記録する
2. 接続レイテンシが 200ms を超えたとき、パフォーマンス最適化機能は接続最適化を試行する
3. 複数の接続パスが利用可能なとき、パフォーマンス最適化機能は最速のルートを選択する
4. パフォーマンス劣化が検出されたとき、パフォーマンス最適化機能は分析用の詳細メトリクスをログに記録する
5. パフォーマンス最適化機能は接続統計を維持し、パフォーマンスレポートを提供する

### 要件 5: リソース使用量最適化

**ユーザーストーリー:** システムユーザーとして、最小限のリソース消費により、ツールが他のアプリケーションに影響を与えないようにしたい。

#### 受入基準

1. ツールが実行中のとき、EC2 接続管理システムは通常動作時に 50MB 以下の RAM を使用する
2. セッションを監視中のとき、セッション監視機能は平均 1%以下の CPU を使用する
3. 複数のセッションがアクティブなとき、セッション管理機能は総メモリ使用量を最小化するためにリソースを効率的に共有する
4. セッションがアイドル状態のとき、パフォーマンス最適化機能は CPU 節約のため監視頻度を下げる
5. ツールがバックグラウンド化されたとき、EC2 接続管理システムはリソース消費を削減した低電力モードに入る

### 要件 6: セッション状態管理

**ユーザーストーリー:** ユーザーとして、透明なセッション状態管理により、接続の状況を常に把握したい。

#### 受入基準

1. セッション状態の変更が発生したとき、セッション監視機能は 1 秒以内に表示を更新する
2. 再接続が進行中のとき、EC2 接続管理システムは明確な進捗インジケーターを表示する
3. セッションの健全性が劣化したとき、健全性チェッカーは早期警告通知を提供する
4. 複数のセッションがアクティブなとき、EC2 接続管理システムは統合された状態情報を表示する
5. セッション監視機能はアプリケーション再起動に耐えるためセッション状態を永続化する

### 要件 7: 設定可能な自動再接続ポリシー

**ユーザーストーリー:** パワーユーザーとして、再接続ポリシーを設定可能にすることで、ワークフローのニーズに合わせて動作をカスタマイズしたい。

#### 受入基準

1. 再接続設定を構成するとき、EC2 接続管理システムは再試行間隔のカスタマイズを許可する
2. 最大再試行回数を設定するとき、自動再接続機能は設定された制限を尊重する
3. アグレッシブ再接続モードを有効にするとき、自動再接続機能は最初の 10 回の試行で 500ms ごとに再接続を試行する
4. 自動再接続を無効にするとき、EC2 接続管理システムは明示的なユーザー要求でのみ再接続する
5. カスタム再接続ポリシーが定義されている場合、自動再接続機能はユーザー指定の動作に従う

### 要件 8: 非同期処理による応答性向上

**ユーザーストーリー:** ユーザーとして、応答性の高い UI 操作により、接続操作中でもインターフェースが使用可能な状態を維持したい。

#### 受入基準

1. 接続操作が進行中のとき、EC2 接続管理システムは UI の応答性を維持する
2. 長時間実行される操作が実行されるとき、パフォーマンス最適化機能はブロッキングを防ぐため非同期処理を使用する
3. ユーザー入力が受信されたとき、EC2 接続管理システムはバックグラウンド操作に関係なく 100ms 以内に応答する
4. 複数の操作が同時実行されるとき、パフォーマンス最適化機能はユーザー向け操作を優先する
5. EC2 接続管理システムは並行性を最大化するため、すべての I/O 操作に async/await パターンを使用する

### 要件 9: 接続前診断機能

**ユーザーストーリー:** ユーザーとして、接続を試行する前にEC2インスタンスとSSM環境の状態を診断することで、接続失敗を事前に防ぎたい。

#### 受入基準

1. 接続要求を受信したとき、接続診断機能はEC2インスタンスの基本状態（実行中/停止中）を確認する
2. インスタンス状態チェック後、接続診断機能はSSM管理インスタンスとしての登録状況を確認する
3. SSM前提条件チェック時、接続診断機能はIAM権限、VPCエンドポイント、セキュリティグループ設定を検証する
4. 診断完了時、接続診断機能は接続成功可能性を百分率で表示し、検出された問題を分類して報告する
5. 重大な問題が検出されたとき、接続診断機能は接続を中止し、修復提案を提供する

### 要件 10: 自動修復機能

**ユーザーストーリー:** システム管理者として、診断で発見された問題を自動的に修復することで、手動介入を最小化したい。

#### 受入基準

1. インスタンスが停止状態のとき、自動修復機能はインスタンスを自動的に起動する
2. インスタンス起動後、自動修復機能はSSM管理インスタンスとして登録されるまで待機し、登録状況を3秒間隔で定期的に確認する
3. SSM登録待機中、自動修復機能は待機状況と経過時間をユーザーに表示する
4. SSM登録が完了したとき、自動修復機能は接続可能状態を確認し、セッション確立を試行する
5. SSM登録が一定時間（デフォルト5分）経過しても完了しない場合、自動修復機能はタイムアウトエラーを報告し、トラブルシューティング手順を提供する
6. SSM管理インスタンス未登録が検出されたとき、自動修復機能はSSMエージェントの状態確認と再起動を試行する
7. IAM権限不足が検出されたとき、自動修復機能は必要な権限の詳細と設定手順を提供する
8. セキュリティグループ設定問題が検出されたとき、自動修復機能は推奨設定変更を提案する
9. 修復操作完了後、自動修復機能は修復結果を検証し、接続可能性を再評価する

### 要件 11: 予防的チェック機能

**ユーザーストーリー:** 開発者として、包括的な予防的チェックにより、接続問題の根本原因を事前に特定したい。

#### 受入基準

1. 予防的チェック実行時、予防的チェック機能はEC2インスタンス、SSM、IAM、ネットワーク設定を段階的に検証する
2. 各チェック段階で、予防的チェック機能は進捗状況をリアルタイムで表示し、検出された問題を即座に報告する
3. チェック完了時、予防的チェック機能は問題の重要度（CRITICAL/ERROR/WARNING/INFO）で分類して表示する
4. 接続可能性評価時、予防的チェック機能は検出された問題に基づいて成功確率を算出する
5. 予防的チェック機能は詳細分析コマンドを提案し、問題解決のための具体的な推奨事項を提供する

## セッションアクティビティ判定の詳細

### アクティブセッションの定義

セッションは以下の条件のいずれかを満たす場合にアクティブと判定されます：

- ローカルポートに対してアクティブな TCP 接続が存在する
- 過去 30 秒以内にポートフォワーディング経由でデータ転送が発生した
- SSM セッションプロセスが正常に応答している

### 非アクティブセッションの判定方法

以下の技術的手法を使用してセッションの活動状況を監視します：

1. **ポート監視**: `netstat` または `ss` コマンドを使用してローカルポートの接続状況を定期的にチェック
2. **プロセス監視**: SSM セッションプロセス（`aws ssm start-session`）の状態と CPU 使用率を監視
3. **ネットワーク統計**: `/proc/net/tcp` (Linux) または `Get-NetTCPConnection` (Windows) を使用してデータ転送量を追跡
4. **ハートビート機能**: 定期的に SSM セッションに対してヘルスチェックを実行

### 実装上の考慮事項

- 監視間隔: 5 秒ごとにセッション状態をチェック
- 誤判定防止: 短時間のネットワーク遅延を考慮した猶予時間の設定
- リソース効率: 監視処理自体が軽量であることを保証
